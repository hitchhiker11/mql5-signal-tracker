# MQL5 Parser Service

## Описание
Сервис для парсинга данных сигналов MetaTrader 5 с сайта MQL5.com.
Предоставляет гибкие возможности получения информации о торговых сигналах с различными режимами производительности.

## Особенности новой архитектуры

- **Модульность**: Сервис разбит на множество небольших компонентов с четкими обязанностями
- **Производительность**: Три режима парсинга для разных требований к скорости и полноте данных
- **Кеширование**: Встроенное кеширование для снижения нагрузки на сервер MQL5
- **Надежность**: Улучшенная обработка ошибок и восстановление при сбоях
- **Настраиваемость**: Расширенные опции конфигурации для каждого компонента

## Режимы работы

1. **Быстрый режим (fast)**: Использует облегченный парсер без JavaScript и обработки скриптов. Извлекает только базовую информацию. Самый быстрый, но с минимальным набором данных.

2. **Обычный режим (normal)**: Баланс между скоростью и полнотой данных. Использует оптимизированную очистку HTML и селективную загрузку скриптов.

3. **Расширенный режим (advanced)**: Полный парсинг с JavaScript и загрузкой всех ресурсов. Самый медленный, но предоставляет максимальный объем информации.

## Установка и требования

Сервис работает в рамках Node.js приложения и требует следующие зависимости:

```bash
npm install axios cheerio jsdom node-cache events
```

## Использование

### Базовое использование

```javascript
import MQL5Service from './services/mql5';

// Создаем экземпляр сервиса
const mql5 = new MQL5Service();

// Получаем данные о сигнале
const signalData = await mql5.getSignalData('https://www.mql5.com/ru/signals/1234567');
console.log(signalData);
```

### Использование с опциями

```javascript
import MQL5Service from './services/mql5';

// Настройки сервиса
const options = {
  parsingMode: 'normal', // fast, normal, advanced
  cache: {
    enabled: true,
    ttl: 3600 // время жизни кеша в секундах (1 час)
  },
  logger: {
    level: 'INFO' // ERROR, WARN, INFO, DEBUG
  }
};

// Создаем экземпляр с настройками
const mql5 = new MQL5Service(options);

// Получаем данные о сигнале с переопределением режима
const signalData = await mql5.getSignalData(
  'https://www.mql5.com/ru/signals/1234567',
  { mode: 'fast', bypassCache: false }
);
```

### События

Сервис является EventEmitter и предоставляет ряд событий:

```javascript
// Подписка на события
mql5.on('signalParsed', (data) => {
  console.log(`Сигнал ${data.url} обработан за ${data.processingTime}ms`);
});

mql5.on('error', (error) => {
  console.error(`Ошибка: ${error.message}`);
});

mql5.on('cacheHit', (url) => {
  console.log(`Данные для ${url} взяты из кеша`);
});
```

## Структура проекта

```
services/mql5/
├── index.js              - Основной экспорт и MQL5Service
├── config/
│   └── default.js        - Настройки по умолчанию
├── fetcher/
│   └── MQL5Fetcher.js    - Класс для загрузки HTML с сайта
├── parsers/
│   ├── SimpleHtmlParser.js      - Быстрый парсер (режим 'fast')
│   ├── StandardHtmlParser.js    - Основной парсер (режим 'normal')
│   └── AdvancedHtmlParser.js    - Расширенный парсер (режим 'advanced')
├── utils/
│   ├── FastHtmlCleaner.js      - Быстрая очистка HTML
│   ├── HTMLCleaner.js          - Продвинутая очистка HTML
│   └── CacheManager.js         - Управление кешированием
└── demo.js               - Демонстрационный скрипт
```

## Примеры данных

### Минимальный набор данных (режим 'fast')

```json
{
  "generalInfo": {
    "signalName": "Example Signal",
    "author": "John Doe",
    "price": "$30/month",
    "subscribers": 123,
    "maxDrawdown": "25.4%",
    "growth": "154.3%",
    "age": "2 years"
  },
  "meta": {
    "parsedAt": "2023-11-21T12:34:56.789Z",
    "processingTime": 235,
    "mode": "fast"
  }
}
```

### Полный набор данных (режим 'advanced')

Включает дополнительную информацию о торговле, статистику, графики и подробные сведения.

## Конфигурация

Все настройки хранятся в `config/default.js` и могут быть переопределены при создании экземпляра сервиса.

### Основные настройки:

- `parsingMode` - режим парсинга по умолчанию
- `httpRequest` - настройки HTTP-запросов
- `resourceManagement` - управление ресурсами (скрипты, стили)
- `htmlCleaning` - параметры очистки HTML
- `parsing` - таймауты и опции парсинга
- `cache` - настройки кеширования
- `logger` - настройки логирования

## Расширение

Сервис спроектирован модульно, что позволяет легко расширять его функциональность:

1. **Добавление нового парсера**: создайте класс в директории `parsers` с методом `parse(html, url, options)`
2. **Собственная стратегия кеширования**: модифицируйте `CacheManager.js`
3. **Дополнительные форматы данных**: расширьте методы форматирования в существующих парсерах

## Устранение проблем

### Частые проблемы и решения

1. **Слишком медленный парсинг**
   - Используйте режим `fast` для ускорения
   - Убедитесь, что включено кеширование

2. **Отсутствие нужных данных в результате**
   - Проверьте используемый режим, для полных данных используйте `advanced`
   - Проверьте настройки селекторов HTML в конфигурации

3. **Ошибки при парсинге JavaScript**
   - Увеличьте таймаут для загрузки скриптов в конфигурации
   - Проверьте логи на предмет ошибок загрузки ресурсов

## Лицензия

MIT